// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de usu√°rio para sistema de economia
model User {
  id        String   @id @default(cuid())
  discordId String   @unique
  username  String
  coins     Int      @default(0)
  bank      Int      @default(0)
  xp        Int      @default(0)
  level     Int      @default(1)
  lastDaily DateTime?
  dailyStreak Int    @default(0)
  longestStreak Int  @default(0)
  lastWork  DateTime?
  lastBeg   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stats de combate
  hp        Int      @default(100)
  maxHp     Int      @default(100)
  atk       Int      @default(10)
  def       Int      @default(5)
  spd       Int      @default(8)
  lck       Int      @default(5)
  
  // Progress√£o
  playerClass   PlayerClass @default(ADVENTURER)
  skillPoints   Int         @default(0)
  dungeonXp     Int         @default(0)
  dungeonLevel  Int         @default(1)

  // Relacionamentos
  transactions    Transaction[]
  inventory       UserItem[]
  dungeonRuns     DungeonRun[]
  playerSkills    PlayerSkill[]
  battleLogs      BattleLog[]
  raidParticipations RaidParticipation[]
  userQuests      UserQuest[]
  questCompletions QuestCompletion[]

  @@map("users")
}

// Modelo de itens no jogo
model Item {
  id          String @id @default(cuid())
  name        String @unique
  description String
  price       Int
  rarity      Rarity @default(COMMON)
  category    String
  emoji       String?
  tradeable   Boolean @default(true)
  createdAt   DateTime @default(now())

  // Relacionamentos
  userItems UserItem[]

  @@map("items")
}

// Relacionamento many-to-many entre usu√°rios e itens
model UserItem {
  id         String    @id @default(cuid())
  userId     String
  itemId     String
  quantity   Int       @default(1)
  acquiredAt DateTime  @default(now())
  
  // Campos de equipamento
  isEquipped Boolean   @default(false)
  equipSlot  String?   // WEAPON, ARMOR, ACCESSORY, etc.

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@map("user_items")
}

// Modelo de transa√ß√µes financeiras
model Transaction {
  id        String          @id @default(cuid())
  userId    String
  type      TransactionType
  amount    Int
  reason    String
  createdAt DateTime        @default(now())

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

// Modelo para configura√ß√µes de servidor
model Guild {
  id        String   @id
  name      String
  prefix    String?  @default("m.")
  language  String   @default("pt-BR")
  timezone  String   @default("America/Sao_Paulo")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  config GuildConfig?

  @@map("guilds")
}

// Modelo para configura√ß√µes avan√ßadas por servidor
model GuildConfig {
  id       String @id @default(cuid())
  guildId  String @unique
  
  // Configura√ß√µes de comandos
  commandsEnabled  Boolean @default(true)
  dungeonEnabled   Boolean @default(true)
  economyEnabled   Boolean @default(true)
  animeEnabled     Boolean @default(true)
  
  // Configura√ß√µes visuais
  primaryColor     String  @default("#5865f2")
  successColor     String  @default("#00ff00")
  errorColor       String  @default("#ff0000")
  warningColor     String  @default("#ffff00")
  
  // Emojis personalizados
  pingEmoji        String  @default("üèì")
  helpEmoji        String  @default("üìö")
  successEmoji     String  @default("‚úÖ")
  errorEmoji       String  @default("‚ùå")
  warningEmoji     String  @default("‚ö†Ô∏è")
  loadingEmoji     String  @default("‚è≥")
  
  // Configura√ß√µes de cooldown (em milissegundos)
  defaultCooldown  Int     @default(3000)
  dungeonCooldown  Int     @default(2000)
  economyCooldown  Int     @default(5000)
  
  // Configura√ß√µes de economia
  dailyAmount      Int     @default(100)
  dailyCooldown    Int     @default(86400000) // 24 horas
  
  // Configura√ß√µes de dungeon
  maxDungeonFloor  Int     @default(50)
  startingHp       Int     @default(100)
  xpMultiplier     Float   @default(1.0)
  coinMultiplier   Float   @default(1.0)
  
  // Canais espec√≠ficos (opcional)
  dungeonChannelId String?
  economyChannelId String?
  logChannelId     String?
  
  // Roles permitidas para comandos admin
  adminRoles       String[] @default([])
  moderatorRoles   String[] @default([])
  
  // Configura√ß√µes de salas tempor√°rias
  roomEnabled        Boolean @default(true)
  roomDefaultTimeout Int     @default(30)
  roomMinTimeout     Int     @default(5)
  roomMaxTimeout     Int     @default(480)
  roomMaxPerUser     Int     @default(3)
  roomRequiredRole   String?
  roomAllowExtension Boolean @default(true)
  roomMaxExtension   Int     @default(60)
  roomAutoCleanup    Boolean @default(true)
  
  // Configura√ß√µes de canais de voz extens√≠veis
  voiceEnabled           Boolean  @default(false)
  voiceParentChannel     String?
  voiceChannelTemplate   String   @default("üé§ Canal #{number}")
  voiceUserLimit         Int      @default(0)
  voiceBitrate          Int      @default(64000)
  voiceDeleteWhenEmpty  Boolean  @default(true)
  voiceEmptyTimeout     Int      @default(30000)
  voiceCreatorPermissions Boolean @default(true)
  voiceAllowedRoles     String[] @default([])
  voiceMaxChannels      Int      @default(10)
  
  // Configura√ß√µes de mensagens de boas-vindas
  welcomeEnabled         Boolean  @default(false)
  welcomeChannelId       String?
  welcomeMessage         String   @default("Bem-vindo(a)!")
  welcomeBackgroundColor String   @default("#1a1a2e")
  welcomeBackgroundUrl   String?
  welcomeMentionUser     Boolean  @default(true)
  welcomeDeleteAfter     Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@map("guild_configs")
}

// Modelo para comandos personalizados por servidor
model CustomCommand {
  id        String   @id @default(cuid())
  guildId   String
  name      String
  content   String
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, name])
  @@map("custom_commands")
}

// === SISTEMA DE DUNGEON ===

// Modelo para execu√ß√µes de dungeon
model DungeonRun {
  id           String   @id @default(cuid())
  userId       String
  seed         String
  currentFloor Int      @default(1)
  positionX    Int      @default(0)
  positionY    Int      @default(0)
  mapData      Json     // Mapa serializado
  inventory    Json     // Itens coletados
  visitedRooms String   @default("") // Progresso comprimido de salas visitadas
  health       Int      @default(100)
  maxHealth    Int      @default(100)
  progress     Float    @default(0)
  biome        BiomeType @default(CRYPT)
  isActive     Boolean  @default(true)
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  battleLogs BattleLog[]

  @@map("dungeon_runs")
}

// Modelo para monstros/mobs
model Mob {
  id          String   @id @default(cuid())
  name        String
  type        MobType
  levelMin    Int
  levelMax    Int
  description String?
  emoji       String?
  
  // Stats base
  baseHp      Int
  baseAtk     Int
  baseDef     Int
  baseSpd     Int
  baseLck     Int
  
  // Configura√ß√µes
  skills      String[] // IDs das skills
  lootTable   Json     // Tabela de drops
  biomes      BiomeType[] // Biomas onde aparece
  
  createdAt   DateTime @default(now())

  @@map("mobs")
}

// Modelo para skills/habilidades
model Skill {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  type        SkillType
  power       Int       @default(0)
  accuracy    Float     @default(1.0)
  cost        Int       @default(0)  // Custo de mana/stamina
  cooldown    Int       @default(0)  // Turnos de cooldown
  heal        Int       @default(0)  // Cura
  effects     Json?     // Efeitos especiais
  
  // Requisitos
  classRequired PlayerClass?
  levelRequired Int       @default(1)
  
  createdAt   DateTime  @default(now())

  // Relacionamentos
  playerSkills PlayerSkill[]

  @@map("skills")
}

// Relacionamento entre players e skills
model PlayerSkill {
  id      String @id @default(cuid())
  userId  String
  skillId String
  level   Int    @default(1)
  
  // Relacionamentos
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("player_skills")
}

// Modelo para logs de batalha
model BattleLog {
  id            String   @id @default(cuid())
  userId        String
  dungeonRunId  String?
  raidId        String?
  mobName       String
  result        String   // "win", "loss", "flee"
  damageDealt   Int      @default(0)
  damageTaken   Int      @default(0)
  xpGained      Int      @default(0)
  coinsGained   Int      @default(0)
  loot          Json?    // Itens dropados
  duration      Int      @default(0) // Turnos
  createdAt     DateTime @default(now())

  // Relacionamentos
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dungeonRun DungeonRun? @relation(fields: [dungeonRunId], references: [id], onDelete: Cascade)
  raid       Raid?       @relation(fields: [raidId], references: [id], onDelete: Cascade)

  @@map("battle_logs")
}

// === SISTEMA DE RAIDS ===

// Modelo para raids cooperativas
model Raid {
  id          String   @id @default(cuid())
  name        String
  description String
  seed        String
  bossName    String
  bossHp      Int
  currentHp   Int
  maxPlayers  Int      @default(20)
  isActive    Boolean  @default(true)
  startedAt   DateTime @default(now())
  endsAt      DateTime
  createdAt   DateTime @default(now())

  // Relacionamentos
  participants RaidParticipation[]
  battleLogs   BattleLog[]

  @@map("raids")
}

// Participa√ß√£o em raids
model RaidParticipation {
  id           String   @id @default(cuid())
  userId       String
  raidId       String
  damageDealt  Int      @default(0)
  healsGiven   Int      @default(0)
  joinedAt     DateTime @default(now())

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  raid Raid @relation(fields: [raidId], references: [id], onDelete: Cascade)

  @@unique([userId, raidId])
  @@map("raid_participations")
}

// Enums
enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
  MYTHIC
}

enum TransactionType {
  DAILY
  WORK
  BEG
  CRIME
  GAMBLE_WIN
  GAMBLE_LOSS
  TRANSFER_SENT
  TRANSFER_RECEIVED
  SHOP_BUY
  SHOP_SELL
  ADMIN_ADD
  ADMIN_REMOVE
  DUNGEON_REWARD
  BATTLE_WIN
  RAID_REWARD
}

enum PlayerClass {
  ADVENTURER
  WARRIOR
  MAGE
  ROGUE
  CLERIC
  PALADIN
  NECROMANCER
  NINJA
  BERSERKER
  ARCHMAGE
}

enum RoomType {
  EMPTY
  MONSTER
  TRAP
  EVENT
  BOSS
  SHOP
  LOOT
  ENTRANCE
  EXIT
}

enum MobType {
  BEAST
  HUMANOID
  UNDEAD
  ELEMENTAL
  DRAGON
  DEMON
  CONSTRUCT
}

enum SkillType {
  ATTACK
  HEAL
  BUFF
  DEBUFF
  SPECIAL
}

enum StatusEffect {
  POISONED
  BURNED
  FROZEN
  STUNNED
  BLEEDING
  REGENERATING
  BLESSED
  CURSED
  HASTE
  SLOW
}

enum BiomeType {
  CRYPT
  VOLCANO
  FOREST
  GLACIER
  RUINS
  ABYSS
}

// Sistema de Quests Di√°rias
model DailyQuestBoard {
  id          String   @id @default(cuid())
  guildId     String
  date        DateTime @default(now())
  questsData  Json     // Array com as quests do dia
  createdAt   DateTime @default(now())
  
  // Relacionamentos
  userQuests  UserQuest[]
  
  @@unique([guildId, date])
  @@map("daily_quest_boards")
}

model Quest {
  id            String      @id @default(cuid())
  questId       String      @unique // ID √∫nico para identificar tipo de quest
  name          String
  description   String
  category      QuestCategory
  type          QuestType
  targetType    String?     // "kill", "collect", "explore", etc.
  targetValue   Int         // Quantidade necess√°ria
  requirements  Json?       // Requisitos espec√≠ficos
  rewards       Json        // Recompensas (XP, moedas, itens)
  difficulty    QuestDifficulty
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relacionamentos
  userQuests    UserQuest[]
  completions   QuestCompletion[]
  
  @@map("quests")
}

model UserQuest {
  id              String      @id @default(cuid())
  userId          String
  questId         String
  guildId         String
  boardId         String?
  progress        Int         @default(0)
  isCompleted     Boolean     @default(false)
  isRewardClaimed Boolean     @default(false)
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  claimedAt       DateTime?
  
  // Relacionamentos
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest           Quest       @relation(fields: [questId], references: [id], onDelete: Cascade)
  board           DailyQuestBoard? @relation(fields: [boardId], references: [id], onDelete: SetNull)
  
  @@unique([userId, questId, guildId, boardId])
  @@map("user_quests")
}

model QuestCompletion {
  id          String   @id @default(cuid())
  userId      String
  questId     String
  guildId     String
  completedAt DateTime @default(now())
  rewardXp    Int      @default(0)
  rewardCoins Int      @default(0)
  rewardItems Json?    // Array de itens recebidos
  
  // Relacionamentos
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  @@map("quest_completions")
}

model QuestRanking {
  id              String   @id @default(cuid())
  guildId         String
  userId          String
  username        String
  dailyCompleted  Int      @default(0)
  weeklyCompleted Int      @default(0)
  totalCompleted  Int      @default(0)
  totalXp         Int      @default(0)
  totalCoins      Int      @default(0)
  lastUpdated     DateTime @default(now())
  
  @@unique([guildId, userId])
  @@map("quest_rankings")
}

enum QuestCategory {
  COMBAT      // Batalhas e combate
  EXPLORATION // Explora√ß√£o de dungeons
  COLLECTION  // Coleta de itens
  SOCIAL      // Atividades sociais
  DAILY       // Atividades di√°rias
  SPECIAL     // Eventos especiais
}

enum QuestType {
  KILL_MOBS       // Matar X mobs
  EXPLORE_ROOMS   // Explorar X salas
  COLLECT_ITEMS   // Coletar X itens
  EARN_COINS      // Ganhar X moedas
  USE_COMMANDS    // Usar comandos X vezes
  WIN_BATTLES     // Vencer X batalhas
  REACH_FLOOR     // Chegar ao andar X
  FIND_TREASURE   // Encontrar X tesouros
  SURVIVE_TIME    // Sobreviver X tempo
  COMPLETE_DAILY  // Completar daily tasks
}

enum QuestDifficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
  LEGENDARY
}

// Log de atividades da economia para monitoramento
model EconomyLog {
  id        String   @id @default(cuid())
  userId    String
  guildId   String?
  action    String   // USER_SUSPENDED, USER_FLAGGED, LARGE_TRANSACTION, etc.
  details   String?  // JSON com detalhes
  severity  String   // LOW, MEDIUM, HIGH, CRITICAL
  createdAt DateTime @default(now())

  @@map("economy_logs")
}

// Sistema de mem√≥ria de mensagens para aprendizado contextual
model MessageMemory {
  id            String   @id @default(cuid())
  guildId       String
  channelId     String
  authorId      String
  authorName    String
  content       String   // Conte√∫do normalizado
  originalContent String // Conte√∫do original
  embedding     String?  // JSON array de embeddings
  relevance     Float    @default(1.0) // Score de relev√¢ncia
  reactions     Int      @default(0) // N√∫mero de rea√ß√µes
  mentions      Int      @default(0) // N√∫mero de men√ß√µes
  wordCount     Int      @default(0)
  sentiment     String?  // POSITIVE, NEUTRAL, NEGATIVE
  topics        String?  // JSON array de t√≥picos detectados
  createdAt     DateTime @default(now())
  
  @@index([guildId, createdAt])
  @@index([authorId])
  @@index([relevance])
  @@map("message_memory")
}

// Contexto aprendido por servidor
model GuildContext {
  id              String   @id @default(cuid())
  guildId         String   @unique
  personality     String   @default("friendly") // friendly, funny, serious, helpful
  learningEnabled Boolean  @default(true)
  responseRate    Float    @default(0.1) // 10% chance de responder
  minWordCount    Int      @default(3)
  maxMemorySize   Int      @default(10000)
  blacklistedWords String? // JSON array
  whitelistedChannels String? // JSON array
  topics          String?  // JSON com t√≥picos mais discutidos
  lastCleanup     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("guild_context")
}